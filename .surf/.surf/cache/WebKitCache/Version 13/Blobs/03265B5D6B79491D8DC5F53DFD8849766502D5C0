"use strict";FastMail.theme.imageDidLoad("all","add_8x8.png","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAH0lEQVR4AWP4//8/HAPBfxBGFqNcAVgQHyaogA6OBADq54d54M+rpgAAAABJRU5ErkJggg=="),FastMail.theme.imageDidLoad("all","loadingdark.gif","data:image/gif;base64,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"),FastMail.theme.imageDidLoad("all","placeholder.png","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAF3CAMAAABkLEnOAAAAA1BMVEXm5uZLWILvAAAAzUlEQVR4Ae3BMQEAAADCIPunNsN+YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3QHeAQABhHFpogAAAABJRU5ErkJggg=="),function(e){e.mail.screens.compose=new O.Object({subject:O.bind("instance.subject"),title:function(){return"* "+(this.get("subject")||O.loc(1319))}.property("subject"),_isActive:!1,activate:function(t){var i,s,o,n=e.mail,a=n.get("composeDetails"),r=(a?(s=a.header)?"Templates"!==s.get("mailbox").get("name")?new e.DraftCardView({content:s,isFirst:!0,isLast:!0}):new e.NewCardView(s.get("id"),"asNew"):(i=a.mode)?new e.NewCardView(a.referenceTo,i):(o=a.controller)?o.get("view"):null:null)||new e.ComposeController(a,!0).get("view"),A=e.views.compose;this.goAfter=t===n.screens.conversation&&"Templates"!==n.get("mailbox").get("name")?"conversation":"mailbox",n.set("composeDetails",null),A.insertView(r,null,"top"),this.resumeBindings(),this.set("_isActive",!0)},deactivate:function(){if(this._isActive){var t=e.views.compose,i=t.get("childViews")[0];i&&(t.removeView(i),i.destroy()),this.suspendBindings(),this.set("_isActive",!1)}},exit:function(){e.mail.set("screen",this.goAfter||"mailbox")},selectedConversations:[],instance:null,instanceCount:0,nextEventTarget:function(){return this.get("instance")}.property().nocache(),_instances:{},registerInstance:function(e){this._instances[e.get("id")]=e,this.increment("instanceCount",1)},deregisterInstance:function(e){delete this._instances[e.get("id")],this.get("instance")===e&&this.set("instance",null),this.increment("instanceCount",-1)},getInstanceByMsgId:function(e){var t,i,s=this._instances;for(t in s)if((i=s[t]).get("messageId")===e)return i;return null},discardAll:function(){var t,i,s=this._instances;for(t in s)(i=s[t])instanceof e.ComposeController&&i.discard()},instanceProps:null,_setOnInstance:function(){var e,t=this.get("instance"),i=this.get("instanceProps");if(t&&i){for(e in i)t.set(e,i[e]);this.set("instanceProps",null)}}.observes("instanceProps","instance"),sourceDidFetchNewMessage:function(e){var t=this._instances[e.clientId];t&&t.sourceDidFetchNewMessage(e)},sourceDidSaveOrSendMessage:function(e){var t=this._instances[e.clientId];t&&t.sourceDidSaveOrSendMessage(e)},sourceDidFailToSend:function(e){var t=this._instances[e.clientId];t&&t.sourceDidFailToSend(e)},referenceMessageNotFound:function(e){var t=this._instances[e.clientId];t&&t.referenceMessageNotFound(e)}}),e.views.mailToolbar.registerBinding(new O.Binding({transform:O.Transform.toBoolean}).from("instance",e.mail.screens.compose).to("inCompose",e.views.mailToolbar).connect())}(FastMail),function(e){var t=e.mail.screens.compose;e.views.compose=new O.ScrollView({id:"compose",isFirst:!0}),e.views.mailToolbar.registerViews({send:new O.ButtonView({type:"s-send",icon:"icon-paper-plane",isDisabled:O.bind(t,"instance.isSending"),label:O.loc(110),tooltip:O.loc(0,O.formatKeyForPlatform("cmd-enter")),target:t,action:"send"}),saveDraft:new O.ButtonView({type:"s-save-draft",icon:"icon-cloud-upload",isDisabled:O.bind(t,"instance.saveIsDisabled"),label:O.bind(t,"instance.saveText",O.Transform.defaultValue(O.loc(181))),tooltip:O.loc(0,O.formatKeyForPlatform("cmd-s")),target:t,action:"save"}),discard:new O.ButtonView({type:"s-discard",icon:"icon-blocked",isDisabled:O.bind(t,"instance.isSending"),label:O.loc(180),tooltip:O.loc(0,O.formatKeyForPlatform("shift-alt-cmd-backspace")),target:t,action:"discard"})}),e.theme.addStylesheet("compose")}(FastMail),function(e){var t=function(t,i,s,o,n){var a=encodeURIComponent;return e.auth.authenticateUrl("/unsafecontent/"+(o?"draft-attachment/":"mail-attachment/")+s+"/"+a(t)+"/"+a(i)+(n?"?download=1":""))},i=O.Class({Extends:O.Object,nextEventTarget:e.api.upload,id:"",type:"",name:"",size:0,progress:0,isInline:!1,isUploaded:!1,isTooBig:!1,composeController:null,init:function(e,t,s){this.composeController=t,this.name=e.name||"image."+(/\w+$/.exec(e.type)||["png"])[0],this.size=e.size,this.type=e.type,this.isInline=!(!e.isInline&&!s),this._imageInfo=s,i.parent.init.call(this),e.id?this.set("id",e.id).set("progress",100).set("isUploaded",!0):t.attachmentWillAttemptUpload(this)?(s&&this.set("id",s.id),this.upload(e)):(alert(O.loc(409,this.name)+" "+O.loc(414,"50MB")),this.set("isTooBig",!0),O.RunLoop.queueFn("before",this.remove,this))},destroy:function(){var t=this.get("composeController"),s=this._request,o=this._imageInfo,n=window.URL||window.webkitURL;o&&(n&&n.revokeObjectURL&&n.revokeObjectURL(o.src),o.overlay&&o.overlay.destroy()),s&&e.api.upload.abort(s),this.get("isUploaded")||this.get("isTooBig")||t.attachmentDidAttemptUpload(this),i.parent.destroy.call(this)},upload:function(t){var i,s,o=this.get("composeController"),n=o.get("draftId");this._file=t,n?(i=new FormData,e.auth.authenticateFormData(i),this._imageInfo&&!e.resizeImage&&i.append("constrainImageTo","2048"),i.append("draftId",n),i.append("name",this.name),t.isFromFS?i.append("path",t.path):i.append("file",t),s=this._request=new O.HttpRequest({nextEventTarget:this,method:"POST",url:e.auth.authenticateUrl("/at/u/"),contentType:"multipart/form-data",data:i}),e.api.upload.send(s)):(o.addObserverForKey("draftId",this,"_retry"),O.RunLoop.queueFn("before",o.fire.bind(o,"save",{auto:!0})))},localImageSrc:function(){var e=this._imageInfo;return e?e.src:null}.property("isUploaded"),_retry:function(e,t){e&&t&&e.removeObserverForKey(t,this,"_retry"),this.isDestroyed||this.upload(this._file)},_uploadDidProgress:function(){this.set("progress",this._request.get("uploadProgress"))}.on("io:uploadProgress"),_uploadDidSucceed:function(i){var s,o,n,a,r,A,l,c,d,h,g,u,p,m,f,v,w=this.get("composeController"),y=e.store;try{s=JSON.parse(i.data)[0]}catch(e){}if(!s||"error"===s[0])return this._uploadDidFail(i,s&&s[1]);if(r=(o=s[1]).messageId,delete o.messageId,this.beginPropertyChanges().set("id",n=o.id).set("name",a=o.name).set("size",o.size).set("progress",100).set("isUploaded",!0).endPropertyChanges(),(d=this._imageInfo)&&!d.hasPreview&&(h=d.rte.get("editor")))for(u=(g=h.getRoot().querySelectorAll("[data-imgid="+d.id+"]")).length;u--;)g[u].src=t(n,a,w.get("draftId"),!0,!1),d.src=null;(A=w.get("messageId"))&&r&&(n=w.get("id"),l=y.getStoreKey(e.MessageDetails,A),(c=y.getData(l))&&(e.api.mail.updateDraftIds(n,A,r),c.attachments.push(o))),e.api.mail.addAttachmentToDrafts(n,o),r&&w.set("messageId",r),w.attachmentDidAttemptUpload(this),this._file.isFromFS&&(f=(m=(p=this._file.path).indexOf("/"))>-1?p.slice(0,m):p,(v=y.getQuery(f+"recent"))&&v.refresh(!0))}.on("io:success"),_uploadDidFail:function(t,i){if(this.set("progress",0),!i)try{i=JSON.parse(t.data)[0][1]}catch(s){400===t.status&&/^video\/.*$/.test(this.type)&&(i={type:"invalidArguments"},e.notifications.show(new e.NotificationView({userMayClose:!0,text:O.loc(155,1,this.name)+"\n\n"+O.loc(276,O.loc(128)),precedence:-10})))}if(i){var s,o=i.type,n=this.get("composeController");"authentication"===o?e.auth.set("isAuthenticated",!1).addObserverForKey("isAuthenticated",this,"_retry"):"idNotFound"===o?n.addObserverForKey("draftId",this,"_retry").fire("save",{auto:!0}):"sizeLimitExceeded"===o?(this.set("isTooBig",!0),n.attachmentDidAttemptUpload(this)):(this.remove(),"remoteUnavailable"===o&&(s=(s=i.service||"fs/dropbox").slice(s.lastIndexOf("/")+1),e.notifications.show(O.loc(156,e.fsServiceName[s+":"]),15e3)))}else O.RunLoop.invokeAfterDelay(this._retry,3e4,this)}.on("io:failure"),_uploadDidEnd:function(e){var t=e.target;t.destroy(),this._request===t&&(this._request=null)}.on("io:end"),remove:function(){var e=this.get("composeController"),t=this.get("view");e.removeAttachment(this),t&&t.detach().destroy(),this.destroy()}});e.AttachmentController=i;var s=O.Class({Extends:O.Object,progress:O.bind("controller*progress"),init:function(e,t,i){this.controller=t,this.container=e,s.parent.init.call(this);var o=e.ownerDocument,n=this.layer=o.createElement("span");n.className="v-ComposeAttachment-imageProgress",n.appendChild(o.createTextNode(O.loc(79,i||"")+" ")),O.FormUploader===O.XHR&&(n.appendChild(this.progressEl=o.createTextNode("0")),n.appendChild(o.createTextNode("%"))),e.appendChild(n)},_progressDidChange:function(){var e,t,i=this.get("progress");100===i?(t=(e=this.layer).parentNode)&&t.removeChild(e):(e=this.progressEl)&&(e.data=i+"")}.queue("render").observes("progress")}),o=O.Class({Extends:O.View,controller:null,isInline:O.bind("controller*isInline"),isUploaded:O.bind("controller*isUploaded"),isTooBig:O.bind("controller*isTooBig"),messageId:O.bind("controller.composeController*messageId"),draftId:O.bind("controller.composeController*draftId"),init:function(e){this.controller=e,o.parent.init.call(this),e.set("view",this)},layerTag:"span",className:function(){return this.get("isInline")?"u-hidden":"v-ComposeAttachment v-Compose-lozenge u-ellipsis"+(this.get("isTooBig")?" is-tooBig":"")}.property("isInline","isTooBig"),draw:function(e,i,s){var o=this.get("controller"),n=o.get("id"),a=o.get("name"),r=o.get("size"),A=o.get("isTooBig"),l=this.get("draftId");return[A?O.loc(1127):[this._progressEl=s("span.v-ComposeAttachment-progress",{style:"width: "+o.get("progress")+"%;"}),n?this._link=s("a.v-ComposeAttachment-download",{text:a,tabIndex:-1,href:t(n,a,l||this.get("messageId"),!!l,!0)}):s("span",{style:"position:relative"},[a]),r?s("span.v-ComposeAttachment-size",{text:"("+O.i18n.fileSize(r,1)+")"}):null],s("span.v-ComposeAttachment-divider"),this._removeBtn=s("span.v-ComposeAttachment-remove",[s("i.icon.icon-close"),O.loc(1093)])]},composeAttachmentNeedsRedraw:function(e,t){t="Id"===t.slice(-2)?"href":"layer",this.propertyNeedsRedraw(e,t)}.observes("isUploaded","isTooBig","messageId","draftId"),redrawHref:function(){var e=this._link,i=this.get("draftId"),s=this.get("controller"),o=s.get("id"),n=s.get("name");e&&(e.href=t(o,n,i||this.get("messageId"),!!i,!0))},renderSending:function(){var e=O.Element.create,t=this.get("controller"),i=t.get("size");return this._sendRender=e("p.v-Compose-sendSection",[e("h4.v-Compose-sendAttTitle",[t.get("name"),i?e("span.v-ComposeAttachment-size",[O.i18n.fileSize(i,1)]):null]),i?e("div.v-Compose-sendAttBar",[this._progressEl=e("div.v-Compose-sendAttProgress")]):null])},_progressDidChange:function(){this._progressEl.style.width=this.getFromPath("controller.progress")+"%"}.queue("render").observes("controller.progress"),didUpload:function(){var e=this._sendRender;e&&this.get("isUploaded")&&(e.className="u-hidden")}.queue("render").observes("isUploaded"),_remove:function(e){O.Element.contains(this._removeBtn,e.target)&&this.get("controller").remove()}.on("click")});e.ImageUploadingOverlay=s,e.ComposeAttachmentView=o}(FastMail),function(e){var t=function(t){return t||e.theme.getImageSrc("avatar.png")};e.ComposeFromView=O.Class({Extends:O.View,controller:null,personality:O.bind("controller.personality"),colour:O.bind(null,"personality.email",function(e){return e?e.toLowerCase().hash().mod(7):0}),positioning:"absolute",layout:O.View.LAYOUT_FILL_PARENT,draw:function(i,s,o){var n=e.personalities,a=this.get("controller");return[o("img",{className:O.bind(this,"colour",function(e){return"v-ComposeFrom-avatar app-avatar u-bgcolour"+e}),src:O.bind(this,"personality.avatar",t)}),o("h2",{className:O.bind(this,"colour",function(t){return"v-ComposeFrom-name u-ellipsis"+(e.preferences.get("enableConversations")?" u-colour"+t:"")}),text:O.bind(this,"personality.name")}),this._bottom=o("p.v-ComposeFrom-bottom",[1===n.get("length")?o("div.u-ellipsis",{style:"line-height:1.7"},[n.getObjectAt(0).get("email")]):new O.SelectView({tabIndex:2,personalities:n,value:O.bindTwoWay(a,"personality"),options:function(){return this.get("personalities").map(function(e){return{text:e.get("displayOrFull"),value:e}})}.property("personalities.[]")})])]}})}(FastMail),function(e,t){var i=O.bindTwoWay,s=O.Transform.toBoolean,o=!O.Element.create("input",{type:"file"}).disabled&&!/iP(?:hone|[ao]d).*OS 8_0 .*Safari/.test(navigator.userAgent),n=function(e){return O.loc(482,e||1)},a="send-failed-"+Date.now(),r=function(e){return"v-Button--hasTick"+(e?" is-on":"")},A=O.Class({Extends:O.View,Mixin:O.DropTarget,destroy:function(){this.get("controller").viewWillDestroy()},controllerDidDestroy:O.View.prototype.destroy,className:"v-Compose app-contentCard",isIOSApp:function(){return O.UA.isIOS&&e.isApp}.property(),willEnterDocument:function(){var t=e.mail.screens.compose.get("instance");return t&&t!==this.get("controller")&&(this._activeComposeView=t.get("view").saveScrollPosition()),A.parent.willEnterDocument.call(this)},didEnterDocument:function(){A.parent.didEnterDocument.call(this);var t=this.get("controller"),i=!this._scrollView,s=this._activeComposeView,o=i&&!s&&e.wc.get("isFocussed"),n=document.activeElement,a=this.getParent(O.ScrollView);if(i){var r=a.get("pxHeight")-this.get("pxHeight")-32,l=this.get("bodyView"),c={minHeight:l.get("layout").height+Math.max(0,r)};O.UA.isIOS||(this.get("bodyIsHTML")?l.get("editor").moveCursorToStart():l.set("selection",{start:0})),l.set("layout",c).redraw(),this.computedPropertyDidChange("pxHeight")}o?this.get("parentView").get("isFirst")?a.scrollTo(0,0):a.scrollToView(this,{x:-15,y:-15}):s&&(s.restoreScrollPosition(),this._activeComposeView=null),this._scrollView=a.addObserverForKey("scrollTop",this,"checkPosition"),this.checkPosition();var d=null;if(o?d=this.get(t.get("to")?t.get("subject")?"bodyView":"subjectView":"toView"):n&&n.focus&&(d=n),d&&e.canSetFocus){var h=e.isMobile&&this.getParent(e.ModalPaneView);h&&(h.get("animating")||h.get("layout")!==h.get("activeLayout"))?h.addObserverForKey("animating",{focus:function(e,t,i,s){s||(e.removeObserverForKey(t,this,"focus"),d.focus())}},"focus"):d.focus()}return t.viewDidEnterDoc(),this},willLeaveDocument:function(){var t=this.get("controller"),i=e.mail.screens.compose;return i.get("instance")===t&&i.set("instance",null),this._scrollView.removeObserverForKey("scrollTop",this,"checkPosition"),t.viewWillLeaveDoc(),A.parent.willLeaveDocument.call(this)},updateComposeCount:function(){var t=e.mail.screens.conversation;t&&t.increment("composeCount",this.get("isInDocument")?1:-1)}.observes("isInDocument"),saveScrollPosition:function(){var e=this._scrollView,t=this._saveScrollCounter||0;return 1===(t+=1)&&(this._scrollOffset=e.get("scrollTop")-this.getPositionRelativeTo(e).top),this._saveScrollCounter=t,this},restoreScrollPosition:function(){var e=this._scrollView,t=this._saveScrollCounter-1;return t||e.scrollTo(0,this._scrollOffset+this.getPositionRelativeTo(e).top),this._saveScrollCounter=t,this},checkPosition:function(){if(this.get("isInDocument")){var t,i=this._scrollView,s=i.get("scrollTop"),o=i.get("pxHeight")>>2,n=this._offsetHeight,a=this._offsetTop,r=this.get("controller"),A=e.mail.screens.compose,l=Date.now();(!a||this._offsetExpiry<l)&&(this._offsetHeight=n=this.get("layer").offsetHeight,this._offsetTop=a=this.getPositionRelativeTo(i).top),this._offsetExpiry=l+500,(t=a-o<s&&s<a+n-3*o)?A.set("instance",r):t||A.get("instance")!==r||A.set("instance",null)}}.queue("after"),plainBodyView:function(){return new O.TextView({tabIndex:8,layout:{height:300},inputAttributes:{spellcheck:"true"},isMultiline:!0,isExpanding:!0,value:i(this.get("controller"),"plainBody")})}.property(),richBodyView:function(){var t=this.get("controller"),i=e.preferences.get("defaultStyle");return new O.RichTextView({label:O.loc(788),tabIndex:8,blockDefaults:{blockAttributes:i?{style:i}:null,tagAttributes:{blockquote:{type:"cite"},li:i?{style:i}:null}},showToolbar:!e.isApp&&!e.isMobile&&!O.UA.isIOS,layout:{height:300},styles:t.convertCidsToRealUrls(t.get("bodyStyles"))}).set("value",t.convertCidsToRealUrls(t.get("richBody")))}.property(),draw:function(t,n,a){var A,l=this.get("controller"),c=this._ccShown=!!l.get("cc")||e.localPrefs.get("showCc"),d=this._bccShown=!!l.get("bcc")||e.localPrefs.get("showBcc"),h=l.get("mode"),g=this.get("id"),u=e.EmailAutoCompleteSource,p=e.ContactGroupAutoCompleteSource,m=e.EmailTextView,f=e.AutoCompleteView;return[a("div.v-Compose-header",[new e.ComposeFromView({controller:l}),a("div.v-Compose-lastSaved",{text:O.bind(l,"lastSaved",function(e){return e?O.loc(1147,O.i18n.date(e,"shortDateOrTime")):""})}),a("div.v-Compose-addCcBcc",[this._ccToggle=a("a.u-subtleLink",{tabIndex:-1,text:c?O.loc(370):O.loc(381),href:""})," ",this._bccToggle=a("a.u-subtleLink",{tabIndex:-1,text:d?O.loc(369):O.loc(380),href:""})," ",this._more=new O.MenuButtonView({tabIndex:1,type:"v-MenuButton v-Button--standard v-Button--size11",label:O.loc(70),popOverView:e.popOver,alignMenu:"right",menuView:function(){return new O.MenuView({showFilter:!1,options:[O.RichTextView.isSupported&&!O.UA.isWKWebView?new O.ButtonView({type:"v-Button--hasTick",label:O.bind(l,"bodyIsHTML",function(e){return e?O.loc(371):O.loc(372)}),target:l,method:"toggleRich"}):null,new O.ButtonView({type:O.bind(l,"isHighPriority",r),label:"Mark as High Priority",target:l,method:"toggleHighPriority"}),new O.ButtonView({type:O.bind(l,"isReadReceiptRequested",r),label:"Request Read Receipt",target:l,method:"toggleReadReceipt"})].filter(s)})}.property()})])]),n.when(l,"showCustomFrom").show([a("div.v-Compose-section",[a("label.v-Compose-sectionTitle",{for:g+"-from-input"},[O.loc(199)]),this.fromView=new O.TextView({tabIndex:3,id:g+"-from",layerTag:"div",value:i(l,"from")})])]).end(),a("div.v-Compose-section.s-compose-to",[a("label.v-Compose-sectionTitle",{for:g+"-to-input"},[O.loc(200)]),this.toView=A=new m({tabIndex:4,id:g+"-to",value:i(l,"to")}),new f({sources:[u,p],inputView:A})]),this._ccContainer=a("div.v-Compose-section"+(c?"":".u-hidden"),[a("label.v-Compose-sectionTitle",{for:g+"-cc-input"},[O.loc(52)]),A=new m({tabIndex:5,id:g+"-cc",value:i(l,"cc")}),new f({sources:[u,p],inputView:A})]),this._bccContainer=a("div.v-Compose-section"+(d?"":".u-hidden"),[a("label.v-Compose-sectionTitle",{for:g+"-bcc-input"},[O.loc(427)]),A=new m({tabIndex:6,id:g+"-bcc",value:i(l,"bcc")}),new f({sources:[u,p],inputView:A}),n.when(l,"personality.autoBcc").show([a("div.v-Compose-autoBcc",[a("b",[O.loc(163)+": "]),a("span",{text:O.bind(l,"personality.autoBcc")})])]).end()]),a("div.v-Compose-section.s-compose-subject",[a("label",{className:h?"v-Compose-sectionTitle v-Compose-sectionTitle--thin":"v-Compose-sectionTitle",for:g+"-subject-input"},[O.loc(119)]),this.subjectView=h?a("div",[l.get("subject")+" ",this._editLink=a("a.u-subtleLink.u-small",{tabIndex:-1,text:O.loc(5),href:""})]):new O.TextView({tabIndex:7,id:g+"-subject",layerTag:"div",value:i(l,"subject")})]),o?this._attachmentsView=a("div.v-Compose-section",[a("label.v-Compose-sectionTitle.v-Compose-attachIcon",[a("i.icon.icon-paperclip")]),this._attachmentsContainer=a("div.u-containFloats",{style:"margin:-3px 0"},[this._attachButton=new O.MenuButtonView({tabIndex:9,type:"v-Button--standard v-Button--size11 v-Compose-lozenge",label:O.loc(107),prefetch:function(){O.require("files"),O.require("filestorage")}.observes("isActive"),popOverView:e.popOver,menuView:new O.MenuView({showFilter:!1,closeOnActivate:!0,options:[new O.FileButtonView({icon:"icon-screen",label:O.loc(219),acceptMultiple:!0,target:l,method:"attachFiles"}),n.when(this,"isIOSApp").show([new O.FileButtonView({icon:"icon-screen",label:O.loc(128),acceptMultiple:!1,target:l,acceptOnlyTypes:"video/*",method:"attachFiles"})]).end(),new O.ButtonView({icon:"icon-cloud",label:O.loc(1103),target:this,method:"attachFromService",root:"vfs"}),new O.ButtonView({icon:"icon-dropbox",label:O.loc(563,"Dropbox"),target:this,method:"attachFromService",root:"dropbox"})]})}),l.get("attachments").reduce(function(t,i){return i.get("isInline")||t.push(new e.ComposeAttachmentView(i)),t},[])])]):null,this.bodyView=l.get("bodyIsHTML")?this.get("richBodyView"):this.get("plainBodyView")]},renderSending:function(){var t=O.Element.create,i=[],s=this._sendOverlay;s&&s.parentNode.removeChild(s),this.get("childViews").forEach(function(t){t instanceof O.TextView?t.set("isDisabled",!0):t instanceof e.ComposeAttachmentView&&!t.get("isUploaded")&&i.push(t)}),this.get("layer").appendChild(this._sendOverlay=t("div.v-Compose-sendOverlay.fill-parent",[t("div.v-Compose-sendDialog",[t("h2.v-Compose-sendTitle",{text:O.loc(421)+"…"}),i.map(function(e){return e.renderSending()})])]))}.queue("render"),renderSendFailed:function(e){var t=O.Element,i=t.forView(this),s=t.create,o=s("div.v-Compose-sendDialog",[s("h2.v-Compose-sendTitle",{text:O.loc(1169)}),s("p.v-Compose-sendSection",e.split(/\[a=(.*?)\[a\]/).map(function(e,t){return 1&t?s("a",{className:a,href:e.split("]")[0],text:e.split("]")[1],target:"_blank"}):e})),new O.ButtonView({type:"v-Button--constructive v-Button--size13",label:O.loc(1079),target:this,action:"renderResume"})]),n=this._sendOverlay,r=this.getParent(O.ScrollView);n.replaceChild(o,n.firstChild),r&&r.scrollToView(this,{x:-15,y:-15}),t.forView(i)},renderResume:function(){this.get("childViews").forEach(function(e){e instanceof O.TextView&&e.set("isDisabled",!1)});var e=this._sendOverlay;e.parentNode.removeChild(e),this._sendOverlay=null}.queue("render").on("renderResume"),toggleField:function(t){var i,s="_"+t+"Shown",o="_"+t+"Container",n="_"+t+"Toggle",a="show"+t.capitalise();this[s]?(this[s]=!1,O.Element.addClass(this[o],"u-hidden"),this[n].textContent="cc"===t?O.loc(381):O.loc(380),e.localPrefs.set(a,!1)):(this[s]=!0,O.Element.removeClass(this[o],"u-hidden"),this[n].textContent="cc"===t?O.loc(370):O.loc(369),e.localPrefs.set(a,!0),i=this.get("id")+"-"+t,this.get("childViews").find(function(e){return e.get("id")===i}).focus())},makeSubjectEditable:function(){var e=this.get("subjectView");e.previousSibling.className="v-Compose-sectionTitle",this.insertView(this.subjectView=new O.TextView({tabIndex:7,id:this.get("id")+"-subject",layerTag:"div",value:i(this.get("controller"),"subject")}),e,"before"),e.parentNode.removeChild(e),O.RunLoop.invokeInNextFrame(function(){this.get("subjectView").focus()},this)}.queue("render"),insertAttachment:function(t){this.insertView(new e.ComposeAttachmentView(t),this._attachmentsContainer)},bodyIsHTML:O.bind("controller.bodyIsHTML"),switchBodyView:function(){var e=this.get("bodyIsHTML"),t=this.get("bodyView"),i=this.get(e?"richBodyView":"plainBodyView"),s=this.get("controller");t!==i&&(i.set("layout",t.get("layout")),e&&i.set("value",s.convertCidsToRealUrls(s.get("richBody"))),this.replaceView(i,t).set("bodyView",i))}.queue("render").observes("bodyIsHTML"),tidy:function(){var t=this.get("plainBodyView"),i=t.get("selection"),s=i.start,o=i.end,n=s===o,a=t.get("value");a&&(t.blur().set("isDisabled",!0),new O.HttpRequest({timeout:3e4,method:"POST",url:e.auth.authenticateUrl("/services/tidy/"),contentType:"text/plain",data:n?a:a.slice(s,o),onSuccess:function(e){var i=e.data;t.set("value",n?i:a.slice(0,s)+i+a.slice(o)).set("isDisabled",!1).set("selection",{start:n?0:s,end:n?0:s+i.length}).focus()}.on("io:success"),onFailure:function(){t.set("isDisabled",!1),e.notifications.show(O.loc(50),5e3)}.on("io:failure","io:abort"),onEnd:function(){this.destroy()}.on("io:end")}).send())},_dropAttachment:O.Element.create("div.v-Compose-dropArea",[O.Element.create("p.v-Compose-dropText",[O.loc(1141)])]),dropAcceptedDataTypes:{Files:!0},dropEffect:O.DragEffect.COPY,dropEntered:function(e){e.set("dropEffect",this.get("dropEffect")),this._attachmentsView.appendChild(this._dropAttachment)},dropExited:function(e){e.set("dropEffect",O.DragEffect.DEFAULT),this._attachmentsView.removeChild(this._dropAttachment)},drop:function(e){var t=e.getFiles();this.get("controller").attachFiles(t)},attachFromService:function(t){var i=this;O.require("files",function(){if(i.get("isInDocument")){var s=t.get("root"),o=e.userPrefs.get("remoteServices");"vfs"===s||o.fs&&o.fs.indexOf(s)>-1?i.attachFrom(s+":"):O.require("filestorage",function(){e.fsAuthorisationView.set("root",s).set("onSuccess",[i.attachFrom,i,[s+":"]]).authorise(),e.popOver.show({view:e.fsAuthorisationView,alignWithView:i._attachButton,offsetTop:1,showCallout:!0})})}})},attachFrom:function(t){var i="vfs:"===t?e.files.views.storageNodeSelector:e.views.fileSelector,s=i.get("controller"),o=new O.ButtonView({type:"v-Button--constructive v-Button--size16 u-dialog-buttonRight",isDisabled:O.bind(s,"selection.length",O.Transform.invert),label:O.bind(s,"selection.length",n),target:this,method:"attachFSFiles"}),a=i.render().get("selectButton");i.replaceView(o,a).set("selectButton",o),a.destroy(),s.set("root","vfs:"===t?e.auth.get("fileStorageHomeDir"):t).set("allowedTypes",/./).set("acceptMultiple",!0).get("selection").selectAll(!1),e.popOver.show({view:i,alignWithView:this._attachButton,offsetTop:1,showCallout:!0})},attachFSFiles:function(t){var i=t.get("parentView"),s=i.getFromPath("controller.root")+"/",o=0===s.indexOf("vfs:"),n=i.getFromPath("controller.selection.selectedStoreKeys"),a=e.files.models,r=n.map(function(t){var i=o?a.getStorageNodeByKey(t,e.store):e.store.getRecord(e.FSMetadata,"#"+t);return{isFromFS:!0,path:o?i.get("path").replace("/My Files",s):i.get("id"),name:i.get("name")+(i.get(o?"canHaveChildren":"isFolder")?".zip":""),size:i.get("size"),type:i.get("type")}});this.get("controller").attachFiles(r),e.popOver.hide()},_onClick:function(t){var i,s=t.target;if(s===this._ccToggle)this.toggleField("cc");else if(s===this._bccToggle)this.toggleField("bcc");else if(s===this._editLink)this.makeSubjectEditable();else{if(s.className!==a)return;if("/"!==(i=s.getAttribute("href")).charAt(0))return;if(i=i.slice(1).replace(/\?.*/,""),!e.base.pathIsAjax(i))return;e.base.restoreStateFromUrl(i)}t.preventDefault()}.on("click"),_kbShortcuts:function(t){var i=t.altKey,s=t.ctrlKey,o=t.metaKey,n=t.shiftKey;if(e.preferences.get("enableKBShortcuts")&&(o||s)&&o!==s){var a=O.DOMEvent.lookupKey(t,!0),r=!i&&!n,A=this.get("controller"),l=!1;switch(a){case"c":n&&!this._ccShown&&(this.toggleField("cc"),l=!0);break;case"b":n&&!this._bccShown&&(this.toggleField("bcc"),l=!0);break;case"enter":r&&(A.send(),l=!0);break;case"m":s&&r&&!this.get("bodyIsHTML")&&(this.tidy(),l=!0);break;case"s":r&&(A.save({full:!1}),l=!0);break;case"backspace":n&&i&&(A.discard(),l=!0)}l&&t.preventDefault()}}.on("keydown"),messageDidChange:function(){this.get("controller").didChange()}.on("input")});e.ComposeView=A}(FastMail),function(e,t,i){var s=e.toHTML,o=e.toPlainText,n=O.Class({Extends:O.Object,status:0,didChange:function(){return this.set("status",9|this.get("status")),this},init:function(t,i){t||(t={});var a,r,A=e.preferences,l=A.get("defaultStyle"),c="<div"+(l?' style="'+l.replace(/"/g,"'")+'"':"")+"><br></div>",d=O.RichTextView.isSupported,h=t.personality||e.mail.get("mailbox").get("personality"),g=t.bodyIsHTML||!1,u=t.body||"",p=t.mode,m=t.attachments;h&&h.is(O.Status.READY)||(h=e.userPrefs.get("defaultPersonality")),!g&&d?(O.UA.isWKWebView||i&&!p&&A.get("composeInHTML"))&&(u&&(u=s(u,l)),g=!0):g&&!d&&(u=o(u),g=!1),i&&((a=g?h.get("htmlSignature"):h.get("textSignature"))&&(r="forward"===p?A.get("sigPositionOnForward"):A.get("sigPositionOnReply"),g||"after"!==r||/^\-\- \r?\n/m.test(a)||(a=/^\-\-\r?\n/.test(a)?"-- "+a.slice(2):"-- \n"+a),a=(g?c:"\n\n")+a,p&&"before"===r?u=a+u:u+=a),g&&(u=c+u)),O.extend(this,{draftId:t.draftId||null,messageId:t.messageId||null,conversationId:t.conversationId||null,personality:h,from:t.from||h.get("nameAndEmail"),to:t.to||"",cc:t.cc||"",bcc:t.bcc||"",subject:t.subject||"",bodyIsHTML:g,bodyStyles:(t.bodyStyles||"")+"p.MsoNormal,p.MsoNoSpacing{margin:0}",plainBody:g?"":u,richBody:g?u:"",attachments:m?m.map(function(t){return new e.AttachmentController(t,this)},this):[],referenceTo:t.referenceTo||"",mode:p||"",isFlagged:t.isFlagged||!1,isHighPriority:t.isHighPriority||!1,isReadReceiptRequested:t.isReadReceiptRequested||!1}),this._s_msg=e.mail.get("messageId"),this._s_mbx=e.mail.get("mailboxId"),n.parent.init.call(this),this.get("messageId")&&this.set("status",i?12:32),e.mail.screens.compose.registerInstance(this)},isVisible:!1,viewDidEnterDoc:function(){this.set("isVisible",!0).set("status",-4097&this.get("status")),this.startAutoSave()},viewWillLeaveDoc:function(){this.set("isVisible",!1),this.save({full:!0,auto:!0}),this.stopAutoSave()},viewWillDestroy:function(){this.set("status",4096|this.get("status"))},checkDestroy:function(){var e=this.get("status");4096&e&&!(2386&e)&&this.destroy()}.queue("after").observes("status"),destroy:function(){this.stopAutoSave(),this.get("view").controllerDidDestroy(),this.get("attachments").forEach(function(e){e.destroy()}),e.mail.screens.compose.deregisterInstance(this),n.parent.destroy.call(this)},exitCompose:function(){var t,i=this.get("view"),s=i.get("parentView"),o=e.mail,n=o.get("screen");this.get("isVisible")&&("compose"===n?t=o.screens.compose.goAfter:"conversation"===n&&o.get("mailboxId")===e.systemFolderIds.get("drafts")&&(t="mailbox"),t&&o.set("screen",t)),s&&(s.removeView(i),s instanceof e.NewCardView&&s.detach().destroy()),this.viewWillDestroy()},id:function(){return O.guid(this)}.property(),view:function(){return new e.ComposeView({controller:this})}.property(),getMessage:function(e){var t=this.get("bodyIsHTML");return t&&(this.updateRichBody(),e&&this.removeUnusedAttachments()),{clientId:this.get("id"),messageId:this.get("messageId"),draftId:this.get("draftId"),personalityId:this.get("personality").get("id"),from:this.get("from"),to:this.get("to"),cc:this.get("cc"),bcc:this.get("bcc"),subject:this.get("subject"),bodyIsHTML:t,bodyStyles:this.get("bodyStyles"),body:this.get(t?"richBody":"plainBody"),attachments:this.get("attachments").reduce(function(e,t){return t.get("isUploaded")&&e.push({id:t.get("id"),type:t.get("type"),name:t.get("name"),size:t.get("size"),isInline:t.get("isInline")}),e},[]),deleteOtherAttachments:!this.get("uploading"),referenceTo:this.get("referenceTo"),mode:this.get("mode"),isFlagged:this.get("isFlagged"),isHighPriority:this.get("isHighPriority"),isReadReceiptRequested:this.get("isReadReceiptRequested")}},showCustomFrom:function(){return/^\*@/.test(this.get("personality").get("email"))}.property("personality"),setFrom:function(){var t,i=this.get("personality").get("nameAndEmail"),s=this.get("from"),o=/\b[\w\-.%+]+@/;this.get("showCustomFrom")&&(t=o.exec(s)||o.exec(e.auth.get("username"))||[""],i=i.replace("*@",t[0])),this.set("from",i).didChange()}.observes("personality"),cleanSubject:function(e,t,i,s){/[\u0000-\u001f]/.test(s)&&this.set(t,s.replace(/[\u0000-\u001f]/g,""))}.observes("subject"),updateRichBody:function(){this.set("richBody",this.convertRealUrlsToCids(this.getFromPath("view.bodyView.value")))},toggleRich:function(){this.get("bodyIsHTML")?confirm(O.loc(1148))&&this.set("bodyIsHTML",!1):this.set("bodyIsHTML",!0)},convertBodyFormat:function(){if(this.get("bodyIsHTML"))this.set("richBody",s(this.get("plainBody"),e.preferences.get("defaultStyle")));else{var t=this.get("view");this.get("attachments").forEach(function(e){e.set("isInline",!1),e.get("view")||t.insertAttachment(e)}),this.updateRichBody(),this.set("plainBody",o(this.get("richBody")))}}.observes("bodyIsHTML"),makeRichSigMatchPersonality:function(e,t,i){if(this.get("bodyIsHTML")){var s,o,n,a,r,A=this.getFromPath("personality.htmlSignature"),l=this.getFromPath("view.bodyView.editor"),c=l.getDocument(),d=c.createDocumentFragment();if(A)for((s=c.createElement("div")).innerHTML=A;o=s.firstChild;)d.appendChild(o);i?(r=(a=(n=/^<div id="(sig.+?)"/.exec(i))&&n[1])&&l.getRoot().querySelector("#"+a))&&(r.parentNode.replaceChild(d,r),this.didChange()):A&&(l.getRoot().appendChild(d),this.didChange())}}.observes("personality.htmlSignature"),makePlainSigMatchPersonality:function(t,i,s){var o,n,a,r;if(!this.get("bodyIsHTML")){if(a=this.get("personality").get("textSignature"),o="forward"===this.get("mode")?e.preferences.get("sigPositionOnForward"):e.preferences.get("sigPositionOnReply"),n=this.get("plainBody"),"after"===o&&(s&&!/^\-\- \r?\n/m.test(s)&&(s=/^\-\-\r?\n/.test(s)?"-- "+s.slice(2):"-- \n"+s),a&&!/^\-\- \r?\n/m.test(a)&&(a=/^\-\-\r?\n/.test(a)?"-- "+a.slice(2):"-- \n"+a)),(r=s?"after"===o?n.lastIndexOf(s):n.indexOf(s):-1)>-1)n=n.slice(0,r)+a+n.slice(r+s.length),a||(n=n.trim());else{if(!a||s)return;n+="\n\n",n+=a}this.set("plainBody",n),this.didChange()}}.observes("personality.textSignature"),uploading:0,uploadingSize:0,attachmentWillAttemptUpload:function(e){var t=this.get("attachments").reduce(function(e,t){return e+t.size},0)+this.get("uploadingSize"),i=e.get("size");return t+i<52428800&&(this.increment("uploading",1).increment("uploadingSize",i),this.set("status",1024|this.get("status")),!0)},attachmentDidAttemptUpload:function(e){this.get("uploadingSize")&&this.increment("uploadingSize",-e.get("size"));var t=this.get("uploading")-1;this.set("uploading",t),t||this.set("status",-1025&this.get("status"))},attachFiles:function(t){var i,s,o,n=this.get("view"),a=this.get("attachments");for(i=0,s=t.length;i<s;i+=1)o=new e.AttachmentController(t[i],this),a.push(o),n.insertAttachment(o);this.didChange()},removeAttachment:function(e){this.get("attachments").erase(e),this.didChange()},insertImage:function(i,s){var o=t.URL||t.webkitURL,n=s.get("editor"),a={rte:s,id:"inlineImage"+Date.now(),hasPreview:!1},r=function(t){var i=new e.AttachmentController(t,this,a);a.overlay=new e.ImageUploadingOverlay(l,i,t.name),this.get("attachments").push(i),this.get("view").insertAttachment(i),this.didChange()}.bind(this),A=n.getDocument(),l=A.createElement("div"),c=A.createElement("img");l.setAttribute("contenteditable","false"),l.className="align-center",l.style.cssText="position:relative;margin:1em 0;text-align:center;",c.setAttribute("data-imgid",a.id),c.style.cssText="max-width:100%;height:auto;",l.appendChild(c),n.insertElement(l),o?(a.hasPreview=!0,c.onload=function(){c.onload=c.onerror=null,e.resizeImage?e.resizeImage(i,c,2048,r):r(i)}.invokeInRunLoop(),c.onerror=function(){c.onload=c.onerror=null,alert(O.loc(116,i.name)),l.parentNode.removeChild(l)}.invokeInRunLoop(),c.src=a.src=o.createObjectURL(i)):(c.src=a.src=e.theme.getImageSrc("placeholder.png"),r(i))},removeUnusedAttachments:function(){for(var e,t,i,s=this.get("attachments").slice(),o=s.length,n=this.get("richBody"),a=this.get("bodyStyles");o--;)(e=s[o]).get("isInline")&&(t=e.get("id").slice(1,-1),(i=new RegExp(("cid:"+t).escapeRegExp())).test(n)||i.test(a)||e.remove())},convertCidsToRealUrls:function(t){var i=this.get("attachments"),s=this.get("messageId"),o=this.get("draftId");return i.forEach(function(i){if(i.get("isInline")){var n=encodeURIComponent,a=i.get("id"),r=i.get("name"),A=new RegExp(("cid:"+a.slice(1,-1)).escapeRegExp(),"g"),l=e.auth.authenticateUrl("/unsafecontent/"+(o?"draft-attachment/":"mail-attachment/")+(o||s)+"/"+n(a)+"/"+n(r));t=t.replace(A,l)}}),t},convertRealUrlsToCids:function(e){return this.get("attachments").forEach(function(t){if(t.get("isInline")){var i=encodeURIComponent,s=t.get("id"),o=t.get("name"),n=t.get("localImageSrc"),a=new RegExp(n?n.escapeRegExp():"(?:"+location.protocol+")?(?:"+location.host+")?/unsafecontent/(?:draft|mail)-attachment/\\w+/"+i(s).escapeRegExp()+"/"+i(o).escapeRegExp()+"(?:\\?[\\w.&=;]+)?","g");e=e.replace(a,"cid:"+s.slice(1,-1))}}),e},toggleHighPriority:function(){return this.toggle("isHighPriority"),this.didChange()},toggleReadReceipt:function(){return this.toggle("isReadReceiptRequested"),this.didChange()},handleEvent:function(){O.XHR.prototype.makeAsyncRequests=!1,this.save({full:!0,auto:!0})}.invokeInRunLoop(),startAutoSave:function(){this._autoSaveInterval||(this._autoSaveInterval=O.RunLoop.invokePeriodically(this.save.bind(this,{auto:!0}),6e4),t.addEventListener("unload",this,!0))},stopAutoSave:function(){this._autoSaveInterval&&(t.removeEventListener("unload",this,!0),O.RunLoop.cancel(this._autoSaveInterval),this._autoSaveInterval=null)},isOverQuota:!1,isUserSaving:!1,lastSaved:null,saveText:O.loc(181),saveIsDisabled:function(){var e=this.get("status");return this.get("isOverQuota")||this.get("isUserSaving")||192&e||!(1027&e)}.property("status","isOverQuota","isUserSaving"),saveStateDidChange:function(){var e=this.get("status");3090&e||this.set("isUserSaving",!1),this.set("saveText",this.get("isOverQuota")?O.loc(420):this.get("isUserSaving")?1024&e?O.loc(1172):O.loc(19):1027&e?O.loc(181):O.loc(25))}.queue("before").observes("status","isUserSaving","isOverQuota"),save:function(e){e.stopPropagation&&e.stopPropagation();var t=!!e.full,i=this.get("status");e.auto||this.set("isUserSaving",!0),this.get("isOverQuota")||960&i||!(i&(t?8:1))||!t&&2&i||this.set("status",i|(t?2048:2))}.on("save"),_save:function(t,i,s,o){2&o&&!(2&s)&&(e.api.mail.saveDraft(this.getMessage(!1),this.get("conversationId"),!1),o&=-2),!(2048&o)||1024&o||16&o||(e.api.mail.saveDraft(this.getMessage(!0),this.get("conversationId"),!0),o&=-2057,o|=16),this.set("status",o)}.observes("status"),sourceDidSaveOrSendMessage:function(t){var i,s,o=this.get("status");"send"===t.action?(e.notifications.show(O.loc(416),5e3),this.set("status",128),(s=this.get("referenceTo"))&&"reply"===this.get("mode")&&e.api.mail.callMethod("notSpamMessages",{messageIdList:[s],applyToConversation:"no"}),this.exitCompose()):(i=t.messageId,this.set("lastSaved",i?new Date:null).set("draftId",t.draftId).set("messageId",i).set("conversationId",t.conversationId),i||this.set("isOverQuota",!0),o="fullSave"===t.action?-17&(32|o):-3&(4|o),this.set("status",o),768&o&&!(2066&o)&&O.RunLoop.queueFn("middle",this._discard,this))},sourceDidFailToSend:function(e){this.get("view").renderSendFailed(e.explanation),this.set("status",-65&this.get("status")).set("isSending",!1),this.startAutoSave()},isSending:!1,send:function(t){t&&t.stopPropagation();var i,s,o,n,a=this.get("status"),r=this.get("view"),A=!1,l="";64&a||(r.get("toView").focus().blur(),this.get("to")||this.get("cc")||this.get("bcc")?(i=this.get("subject"))||confirm(O.loc(655))?(this.get("bodyIsHTML")?(s=this.getFromPath("view.bodyView.editor"))&&(A=!!(o=s.getDocument()).getElementsByTagName("img").length,l=o.body.textContent):l=this.get("plainBody"),l=String.prototype.trim.call(l),n=/^\-\- \r?\n/.test(l)&&"forward"!==this.get("mode"),l&&!n||A||/[ \(]EOM\)?\s*$/i.test(i)||confirm(O.loc(652))?e.auth.get("isVerified")?(r.renderSending(),this.stopAutoSave(),this.set("status",64|a).set("isSending",!0)):O.require("verify",function(){e.verify.show()}):r.get("bodyView").focus()):r.get("subjectView").focus():r.get("toView").set("isHighlighted",!0).once("blur",function(){this.set("isHighlighted",!1)}).focus())}.on("send"),_send:function(t,i,s,o){!(64&o)||1024&o||64&s&&!(1024&s)||e.api.mail.sendMessage(this.getMessage(!0),this.get("conversationId"))}.observes("status"),discard:function(t){t&&t.stopPropagation();var i=this.get("status");64&i||(i|=256,this.set("status",i),this.exitCompose(),2066&i||(32&i&&!(4&i)?this.set("status",2|i):this._discard()),e.api.mail.setTransaction(new a(this)),e.notifications.show(new e.UndoableNotificationView({text:O.loc(413,1)})))}.on("discard"),_discard:function(){var t,i,s,o=this.get("messageId"),n=this.get("conversationId"),a=e.ConversationDetails,r=e.store,A=r.getQuery(n);o&&(i=(t=r.getRecord(e.MessageHeader,o,!0)).get("mailboxId")||e.systemFolderIds.get("drafts"),s=t.get("storeKey"),A?A.deleteMessages([o],!0):(r.sourceDidDestroyRecords(e.MessageHeader,[o]),r.sourceDidDestroyRecords(e.MessageDetails,[o]),e.api.mail.callMethod("deleteMessages",{messageIdList:[o],applyToConversation:"no",permanently:!0})),(A=r.getQuery(i))&&(A.clientDidGenerateUpdate({removed:[s]}),A.setObsolete()),e.api.mail.refreshMailboxCounts(),r.getRecordStatus(a,n)&O.Status.READY&&r.getRecord(a,n).increment("drafts",-1).setObsolete(),r.getRecord(e.Mailbox,i).increment("totalMessages",-1),this.set("messageId",null))}}),a=O.Class({init:function(e){this.id=O.guid(this),this.controller=e},destroy:function(){var e=this.controller;e&&e.set("status",-257&e.get("status")|512)},undo:function(t){var i=this.controller,s=i&&i.get("conversationId"),o=s&&e.store.getQuery(s),n=e.mail;i&&(i.set("status",-257&i.get("status")).didChange().save({full:!1,auto:!0}),o&&o.refresh(!0),t&&e.api.mail.addCallback(t),e.base.set("app","mail"),s&&e.preferences.get("enableConversations")?(n.beginPropertyChanges().set("screen","conversation"),n.get("conversationId")!==s&&n.set("mailboxId",i._s_mbx).set("messageId",i._s_msg).set("conversationId",s),n.endPropertyChanges()):n.set("composeDetails",{controller:i}).set("screen","compose")),this.controller=null}}),r={gif:!0,jpeg:!0,jpg:!0,png:!0};O.RichTextView.implement({insertImagesFromFiles:function(t){var i,s,o,n,a,A=this.getParent(e.ComposeView).get("controller");for(i=0,s=t.length;i<s;i+=1)a=(n=(o=t[i]).name||"").slice(n.lastIndexOf(".")+1).toLowerCase(),/^image\//.test(o.type)||r[a]?A.insertImage(o,this):alert(O.loc(116,n))}},!0),e.ComposeController=n}(FastMail,window),function(e){var t=function(e){var t=e.MozBlobBuilder||e.MSBlobBuilder||e.WebKitBlobBuilder,i=!!t;try{new Blob,i=!0}catch(e){}var s=e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype,o=!(!s||!s.toBlob);return!o&&i&&e.atob&&e.ArrayBuffer&&e.Uint8Array&&(s.toBlob=function(e,i,s){var o,n,a,r,A=this.toDataURL(i,s),l=atob(A.slice(A.indexOf(",")+1)),c=new ArrayBuffer(l.length),d=new Uint8Array(c);for(o=0,n=l.length;o<n;o+=1)d[o]=l.charCodeAt(o);try{a=new Blob([d],{type:i})}catch(e){}a||((r=new t).append(c),a=r.getBlob(i)),e(a)},o=!0),o}(window);e.resizeImage=t?function(e,t,i,s){var o,n,a,r=e.type,A=t.naturalWidth||t.width,l=t.naturalHeight||t.height;A>i||l>i?A>=l?(n=parseInt(i*l/A,10),o=i):(o=parseInt(i*A/l,10),n=i):"image/tiff"===r&&(o=A,n=l),o&&n?((a=O.Element.create("canvas")).width=o,a.height=n,a.getContext("2d").drawImage(t,0,0,A,l,0,0,o,n),a.toBlob(function(t){e.size<t.size?t=e:t.name=e.name,s(t)},"image/jpeg"===r?r:"image/png",.8)):s(e)}:null}(FastMail);
