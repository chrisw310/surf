"use strict";!function(e,t){var i,n=e.isApp?null:function(){var t,i=null;try{(t=e.loading.layer.getAttribute("data-customLogin"))&&"{}"!==t&&(i=JSON.parse(t))}catch(e){}return i}(),s=(i=/domain=([a-z0-9.-]+)/.exec(t.search))?i[1]:"",o=function(){var e=/[?&]u=(\w+)/.exec(t.search),i=e&&new RegExp("d_"+e[1]+"=([a-z0-9.-]+)").exec(document.cookie)||(s?[null,s]:null)||/\.(.*)/.exec(t.host);return i?i[1]:""}(),a=function(e){return function(t){return t.type===e}},r=e.auth,u=new O.Object({app:"login",appName:O.loc(46),title:O.loc(46),goAfterAuth:"",enter:function(){var t=e.base.get("currentPath");/^login/.test(t)&&(t="mail/"),e.base.closeModals(),e.popOver.hide(),this.goAfterAuth=t,r.addObserverForKey("isAuthenticated",e.login,"hide"),e.views.mainWindow.insertView(e.views.login)},exit:function(){e.views.mainWindow.removeView(e.views.login),r.removeObserverForKey("isAuthenticated",e.login,"hide");var t=this.get("authState")>1;this.restartLogin(),t&&this.goSessions()},hide:function(){return!!r.get("isAuthenticated")&&(e.base.restoreStateFromUrl(this.goAfterAuth),!0)},encode:function(){return""},goUp:function(){return this.hide()},authenticationUrl:"/authenticate/",username:"",usernameDidChange:function(){this.set("loginId","");var e=this.get("authInProgress");e&&e.abort()}.observes("username"),userIsWaiting:function(){return!(!this.get("authInProgress")||!this.get("loginId")&&!this.get("authWaiting"))}.property("authInProgress","loginId","authWaiting"),authState:1,authError:"",authInProgress:null,authWaiting:null,loginId:"",authMethods:null,authMethodTOTP:!1,authMethodU2F:!1,authMethodYubikey:!1,authMethodSMS:!1,authMaySecurityKey:function(){return!(O.UA.isIOS||!this.get("authMethodU2F")&&!this.get("authMethodYubikey"))}.property("authMethodU2F","authMethodYubikey"),mayTrustDevice:!0,trustDevice:!1,sessionsInProgress:null,sessions:null,restartLogin:function(e){return this.set("loginId","").set("authMethods",null).set("authError",e||"").goLogin()},getSessions:function(){if(!this.get("sessionsInProgress")){var e=new O.HttpRequest({timeout:45e3,method:"GET",url:this.get("authenticationUrl"),headers:{Accept:"application/json"},onSuccess:function(e){this.set("sessions",JSON.parse(e.data))}.bind(this).on("io:success"),onFail:function(){this.set("sessions",null)}.bind(this).on("io:failure"),onEnd:function(){this.set("sessionsInProgress",null)}.bind(this).on("io:end")});return this.set("sessionsInProgress",e),e.send(),this}},goSessions:function(){return this.set("authState",0)},goLogin:function(){return this.set("authState",1)},goSecurityKey:function(){return this.set("authError","").set("authState",2)},goTOTP:function(){return this.set("authError","").set("authState",3)},goSMS:function(){return this.set("authError","").set("authState",4)},sendUsername:function(e){e=e.toLowerCase().trim(),this.set("username",e),this.get("loginId")||this.sendAuthRequest({username:e})},sendCodeTo:function(e){var t=this.get("loginId");t&&this.sendAuthRequest({loginId:t,sendCodeTo:e})},sendVerification:function(e,t,i){this.get("authInProgress")?this.set("authWaiting",[e,t,i]):this.sendAuthRequest({loginId:this.get("loginId"),type:e,value:t,remember:i})},sendAuthRequest:function(e){if(!this.get("authInProgress")){var t=new O.HttpRequest({nextEventTarget:this,timeout:45e3,method:"POST",url:this.get("authenticationUrl"),headers:{"Content-Type":"application/json",Accept:"application/json","X-JMAP-AuthCookies":"yes"},data:JSON.stringify(e)});this.set("authError",""),this.set("authInProgress",t),t.send()}},authDidRespond:function(t){var i,n,o,u=this.get("authState");try{i=JSON.parse(t.data)}catch(e){}switch(t.status){case 403:u=this.get("authState"),this.set("authError",(3===u?O.loc(289):4===u?O.loc(215):O.loc(14))+" "+O.loc(16)),g.get("isInDocument")&&g.skiView.activate();case 200:if(i){if(n=i.methods||[],this.set("loginId",i.loginId).set("authMethods",n),!1===i.mayTrustDevice?this.set("mayTrustDevice",!1).set("trustDevice",!1):this.set("mayTrustDevice",!0),n.some(a("password")))break;this.set("authMethodTOTP",n.find(a("totp"))).set("authMethodU2F",O.UA.canU2F&&n.find(a("u2f"))).set("authMethodYubikey",n.find(a("yubikeyotp"))).set("authMethodSMS",n.find(a("sms"))),1===u&&(this.get("authMaySecurityKey")?this.goSecurityKey():this.get("authMethodTOTP")?this.goTOTP():this.get("authMethodSMS")?this.goSMS():this.restartLogin(n.length?O.loc(1368):O.loc(14)));break}this.restartLogin(O.loc(14));break;case 201:if(i){e.localPrefs.set("loginDomain",s),o=r.get("isAuthenticated")&&i.userId===r.get("userId"),r.didAuthenticate(i,this.goAfterAuth),o&&this.hide();break}case 400:O.RunLoop.didError({name:"Malformed authentication request made.",message:this.get("authInProgress").get("data")});case 410:this.restartLogin((1===u?O.loc(425):O.loc(14))+" "+O.loc(16));break;case 423:this.restartLogin(i.description);break;case 429:this.restartLogin(O.loc(729));break;case 404:case 500:case 503:this.restartLogin(O.loc(743))}}.on("io:success","io:failure"),authDidNotRespond:function(){this.set("authError",O.loc(50))}.on("io:abort"),authDidEnd:function(){var e=this.get("authWaiting");this.set("authInProgress",null).set("authWaiting",null),e&&this.sendVerification.apply(this,e)}.on("io:end")}),h=new O.View({className:"v-Login",sessions:O.bind(u,"sessions"),sessionsInProgress:O.bind(u,"sessionsInProgress"),watchForRedraw:function(){var t=e.AvatarManager;this.get("isInDocument")?t.addObserverForKey("*",this,"viewNeedsRedraw"):t.removeObserverForKey("*",this,"viewNeedsRedraw")}.observes("isInDocument"),draw:function(t,i,n){var s=this.get("sessions"),o=this.get("sessionsInProgress");return[n("h1.v-Login-title",[O.loc(69)]),n("div.v-Login-box.u-dialog-contents",[o?new e.LoadingView({positioning:"relative",layout:{marginBottom:-18,height:90}}):s?n("ul.v-Login-sessions",[s.map(function(t,i){var s=t.username;return n("li",[n("a.v-Login-session",{"data-index":i,href:"/mail/?u="+t.userId},[n("i",{className:"v-Login-avatar app-avatar u-bgcolour"+s.toLowerCase().hash().mod(7),style:"background-image: url("+(e.AvatarManager.get(s)||e.theme.getImageSrc("avatar.png"))+")"}),n("div.u-ellipsis.u-bold",[t.displayName]),n("div.u-ellipsis",[s])])])})]):null]),n("p.u-alignCentre",[this._goLogin=n("a.v-Login-sessionNew",{href:"/login/"},[O.loc(787)])])]},viewNeedsRedraw:function(){this.propertyNeedsRedraw(null,"layer")}.observes("sessionsInProgress","sessions"),changeView:function(e){if(!O.DOMEvent.isClickModified(e)){var t,i=e.target;if(i===this._goLogin)return u.goLogin(),void e.preventDefault();for(;i&&"A"!==i.nodeName;)i=i.parentNode;i&&(e.preventDefault(),t=this.get("sessions")[i.getAttribute("data-index")],r.get("isAuthenticated")&&r.get("userId")===t.userId?u.hide():r.didAuthenticate(t,u.goAfterAuth)),e.stopPropagation()}}.on("click")}),l=function(e){"enter"===O.DOMEvent.lookupKey(e)&&this.submit()}.on("keypress"),c=new O.View({className:"v-Login",layerTag:"form",setFocus:function(){this.get("isInDocument")&&(u.get("username")?this._password.focus():this._username.focus())}.queue("after").observes("isInDocument"),draw:function(t,i,s){return t.method="post",t.action="/",8===O.UA.msie&&(t.onsubmit=function(){return this.fire("submit"),!1}.bind(this)),[s("h1.v-Login-title",[n&&n.title||O.loc(46)]),s("div.v-Login-box.u-dialog-contents",[i.when(u,"authError").show([s("div.u-dialog-banner",{html:O.bind(u,"authError")})]).end(),s("p",[s("label.u-formBlock-label",{for:O.View.peekId()+"-input"},[O.loc(81)]),this._username=new O.TextView({tabIndex:1,isDisabled:O.bind(u,"userIsWaiting"),layout:{display:"block"},placeholder:O.loc(34).toLowerCase()+"@"+(o||"example.com"),value:O.bind(u,"username"),inputType:O.UA.isIOS?"email":"text",inputAttributes:{name:"username",autocomplete:"username",autocorrect:"off",autocapitalize:"off",spellcheck:"false"},addDomainAndSend:function(e){if("input"!==e.type||!this.get("isFocussed")){var t=this.get("value");t&&o&&!/[@\/#=]/.test(t)&&(t=t+"@"+o,this.set("value",t)),RegExp.email.test(t)&&u.sendUsername(t)}}.on("input","blur")})]),s("p",[s("label.u-formBlock-label",{for:O.View.peekId()+"-input"},[O.loc(9)]),this._password=new O.TextView({tabIndex:2,isDisabled:O.bind(u,"userIsWaiting"),layout:{display:"inline-block"},value:"",inputType:"password",inputAttributes:{name:"password",autocomplete:"current-password",autocorrect:"off",autocapitalize:"off"},reset:function(){this.get("isInDocument")||this.set("value","").redraw()}.observes("isInDocument")})]),e.isApp?null:s("p",[this._remember=new O.CheckboxView({tabIndex:3,isDisabled:O.bind(u,"userIsWaiting"),value:!1,label:O.loc(1187)})]),s("p.u-alignRight",[s("button",{tabIndex:"4",className:O.bind(u,"userIsWaiting",function(e){return"v-Button v-Button--constructive v-Button--size16"+(e?" is-waiting":"")}),disabled:O.bind(u,"userIsWaiting")},[O.loc(46)])])]),s("p.u-alignCentre",[s("a",{href:"/help/account/icantlogin.html"},[O.loc(577)])]),i.when(u,"sessions").show([s("hr"),s("p.u-alignCentre",[this._goSessions=s("a",{href:"/login/"},[O.loc(1003)])])]).end()]},changeView:function(e){e.target===this._goSessions&&(u.goSessions(),e.preventDefault())}.on("click"),submit:function(t){var i,n,s,o=this._username,a=this._password;if(t.preventDefault(),o.syncBackValue(),a.syncBackValue(),i=o.get("value"),n=a.get("value"),s=e.isApp||this._remember.get("value"),i){if(!RegExp.email.test(i))return u.set("authError",O.loc(425)),void this._username.focus();if(n){try{external.AutoCompleteSaveForm(this.get("layer"))}catch(e){}u.sendUsername(i),u.sendVerification("password",n,s)}else this._password.focus()}else this._username.focus()}.on("submit")}),g=new O.View({className:"v-Login",response:null,draw:function(t,i,n){var s=i.when;return[n("h1.v-Login-title",[O.loc(122)]),n("div.v-Login-box.u-dialog-contents",[s(u,"authError").show([n("div.u-dialog-banner",{text:O.bind(u,"authError")})]).end(),n("p",[O.loc(157)]),this.skiView=new e.SecurityKeyInputView({isForU2F:O.bind(u,"authMethodU2F",O.Transform.toBoolean),isForYubikey:O.bind(u,"authMethodYubikey",O.Transform.toBoolean),challenge:O.bind(u,"authMethodU2F"),response:O.bindTwoWay(this,"response")}),s(u,"mayTrustDevice").show([n("p",[new O.CheckboxView({isDisabled:O.bind(u,"userIsWaiting"),value:O.bindTwoWay(u,"trustDevice"),label:O.loc(164)})])]).end()]),n("h3.v-Login-nav.u-bold",[O.loc(578)]),s(u,"authMethodTOTP").show([n("p.v-Login-nav",[this._goTOTP=n("a",{href:"/login/"},[O.loc(463)])])]).end(),s(u,"authMethodSMS").show([n("p.v-Login-nav",[this._goSMS=n("a",{href:"/login/"},[O.loc(462)])])]).end(),n("p.v-Login-nav",[n("a",{href:"/help/account/icantlogin.html"},[O.loc(216)])]),n("hr"),n("p.u-alignCentre",[n("b",{text:O.bind(u,"username")})," – ",this._goLogin=n("a",{href:"/login/"},[O.loc(69)])])]},changeView:function(e){switch(e.target){case this._goTOTP:u.goTOTP(),e.preventDefault();break;case this._goSMS:u.goSMS(),e.preventDefault();break;case this._goLogin:u.restartLogin(),u.set("username",""),e.preventDefault()}}.on("click"),submit:function(){var e,t,i=this.get("response");i&&!u.get("authInProgress")&&(e="string"==typeof i?"yubikeyotp":"u2f",t=u.get("trustDevice"),u.sendVerification(e,i,t))}.observes("response")}),d=new O.View({className:"v-Login",setFocus:function(){this.get("isInDocument")?this._code.focus():this._code.set("value","")}.queue("after").observes("isInDocument"),draw:function(e,t,i){var n=t.when;return[i("h1.v-Login-title",[O.loc(122)]),i("div.v-Login-box.u-dialog-contents",[n(u,"authError").show([i("div.u-dialog-banner",{text:O.bind(u,"authError")})]).end(),i("p",[i("label",{for:O.View.peekId()+"-input"},[O.loc(665)])]),i("p.u-alignCentre",[this._code=new O.TextView({isDisabled:O.bind(u,"userIsWaiting"),layout:{width:"5em",fontSize:32},placeholder:"XXXXXX",inputAttributes:{name:"totp",autocomplete:"off",pattern:"[0-9]*",maxLength:6},enforceChars:function(){this.set("value",this.get("value").replace(/\D/g,""))}.queue("before").on("input")})]),n(u,"mayTrustDevice").show([i("p",[new O.CheckboxView({isDisabled:O.bind(u,"userIsWaiting"),value:O.bindTwoWay(u,"trustDevice"),label:O.loc(164)})])]).end(),i("p.u-alignCentre",[new O.ButtonView({isWaiting:O.bind(u,"userIsWaiting"),type:"v-Button--constructive v-Button--size16",label:O.loc(124),target:this,method:"submit"})])]),i("h3.v-Login-nav.u-bold",[O.loc(580)]),n(u,"authMaySecurityKey").show([i("p.v-Login-nav",[this._goSecurityKey=i("a",{href:"/login/"},[O.loc(461)])])]).end(),n(u,"authMethodSMS").show([i("p.v-Login-nav",[this._goSMS=i("a",{href:"/login/"},[O.loc(462)])])]).end(),i("p.v-Login-nav",[i("a",{href:"/help/account/icantlogin.html"},[O.loc(216)])]),i("hr"),i("p.u-alignCentre",[i("b",{text:O.bind(u,"username")})," – ",this._goLogin=i("a",{href:"/login/"},[O.loc(69)])])]},changeView:function(e){switch(e.target){case this._goSecurityKey:u.goSecurityKey(),e.preventDefault();break;case this._goSMS:u.goSMS(),e.preventDefault();break;case this._goLogin:u.restartLogin(),u.set("username",""),e.preventDefault()}}.on("click"),submitOnEnter:l,submit:function(){var e=this._code.get("value"),t=u.get("trustDevice");e?u.sendVerification("totp",e,t):this._code.focus()}}),p=new O.View({className:"v-Login",setFocus:function(){this.get("isInDocument")?this._code.focus():this._code.set("value","")}.queue("after").observes("isInDocument"),draw:function(e,t,i){var n=t.when,s=this;return[i("h1.v-Login-title",[O.loc(122)]),i("div.v-Login-box.u-dialog-contents",[n(u,"authError").show([i("div.u-dialog-banner",{text:O.bind(u,"authError")})]).end(),i("p",[O.loc(983)]),i("ul",{children:O.bind(u,"authMethodSMS",function(e){var n=t.forView(s),o=e?e.phoneNumbers.map(function(e){return i("li.v-Login-phone",[i("span.v-Login-phoneNumber",[e.number]),new O.ButtonView({isDisabled:e.isCodeSent||O.bind(u,"authInProgress"),type:"v-Button--standard v-Button--size13",label:e.isCodeSent?O.loc(426):O.loc(110),target:s,method:"sendCode",phone:e})])}):null;return t.forView(n),o})}),i("p",[i("label",{for:O.View.peekId()+"-input"},[O.loc(664)])]),i("p.u-alignCentre",[this._code=new O.TextView({isDisabled:O.bind(u,"userIsWaiting"),layout:{width:"5em",fontSize:32},placeholder:"XXXXXX",inputAttributes:{maxLength:6},enforceChars:function(){this.set("value",this.get("value").replace(/[a-z]/g,function(e){return e.toUpperCase()}).replace(/[^2-9A-HJ-NP-Z]/g,""))}.queue("before").on("input")})]),n(u,"mayTrustDevice").show([i("p",[new O.CheckboxView({isDisabled:O.bind(u,"userIsWaiting"),value:O.bindTwoWay(u,"trustDevice"),label:O.loc(164)})])]).end(),i("p.u-alignCentre",[this._submitButton=new O.ButtonView({type:"v-Button--constructive v-Button--size16",label:O.loc(124),target:this,method:"submit"})])]),i("h3.v-Login-nav.u-bold",[O.loc(579)]),n(u,"authMaySecurityKey").show([i("p.v-Login-nav",[this._goSecurityKey=i("a",{href:"/login/"},[O.loc(461)])])]).end(),n(u,"authMethodTOTP").show([i("p.v-Login-nav",[this._goTOTP=i("a",{href:"/login/"},[O.loc(463)])])]).end(),i("p.v-Login-nav",[i("a",{href:"/help/account/icantlogin.html"},[O.loc(216)])]),i("hr"),i("p.u-alignCentre",[i("b",{text:O.bind(u,"username")})," – ",this._goLogin=i("a",{href:"/login/"},[O.loc(69)])])]},sendCode:function(e){e.set("isWaiting",!0),u.sendCodeTo(e.phone.id)},changeView:function(e){switch(e.target){case this._goSecurityKey:u.goSecurityKey(),e.preventDefault();break;case this._goTOTP:u.goTOTP(),e.preventDefault();break;case this._goLogin:u.restartLogin(),u.set("username",""),e.preventDefault()}}.on("click"),submitOnEnter:l,submit:function(){var e=this._code.get("value"),t=u.get("trustDevice"),i=this._submitButton;e?(i.set("isWaiting",!0),u.once("io:end",function(){i.set("isWaiting",!1)}),u.sendVerification("sms",e,t)):this._code.focus()}}),v=new O.SwitchView({index:O.bind(u,"authState"),views:[h,c,g,d,p]});e.login=u,e.views.login=new e.AppPaneView({id:"login",draw:function(t,i,s){var o=O.Transform.isEqualToValue,a=i.unless,r=e.isApp;return[n?null:s("div#header",[s("div",{id:"header-home",className:r?"header-home--left":""},[s("a",r?null:{href:"/"},[s("img",{src:"/static/images/logo.png",width:"176",height:"44",alt:e.appName})])]),r?null:s("ul#header-nav",[s("li",[s("a",{href:"https://blog.fastmail.com/"},["Blog"])]),s("li",[s("a",{href:"/help/"},["Support"])]),s("li",[s("a",{href:"/signup/"},["Sign up"])]),s("li",[s("a",{href:"/pricing/"},["Pricing"])]),s("li",[s("a",{href:"/forbusiness/"},["Business hosting"])])]),r?null:s("div#header-login",[a(u,"authState",o(0)).show([s("b",["Log in"])]).otherwise([this._goLogin=s("a",{href:"/login/"},["Log in"])]).end()])]),new O.ScrollView({ariaAttributes:{live:"assertive"},className:n?"fill-parent":"app-belowToolbar u-unimportant-bg",layout:{background:n&&n.background,color:n&&n.color},childViews:n&&n.logo?[v,new O.View({layout:{margin:"30px",textAlign:"center"},draw:function(e,t,i){return[i("img",{alt:"",src:n.logo,style:"max-width:100%"})]}})]:[v]})]},click:function(e){e.target===this._goLogin&&(u.restartLogin(),e.preventDefault())}.on("click")}),e.theme.addStylesheet("login"),O.loader.prefetch("mail")}(FastMail,location);
